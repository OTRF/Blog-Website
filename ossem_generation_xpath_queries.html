<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>OSSEM Detection Model: Leveraging Data Relationships to Generate Windows Event XPath Queries</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->
    
    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="Sharing and collaborating to empower the Infosec community!" />
    <link rel="shortcut icon" href="https://blog.openthreatresearch.com/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://blog.openthreatresearch.com/ossem_generation_xpath_queries" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Open Threat Research Blog" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="OSSEM Detection Model: Leveraging Data Relationships to Generate Windows Event XPath Queries" />
    <meta property="og:description" content="In this blogpost, we will introduce the OSSEM Detection Model project and show you how to use it to create Windows Event XPath queries. These XPath queries can then be used to improve your data collection strategy. Prerequisites We highly recommend reading the following blog post about OSSEM Data Dictionaries" />
    <meta property="og:url" content="https://blog.openthreatresearch.com/ossem_generation_xpath_queries" />
    <meta property="og:image" content="https://blog.openthreatresearch.com/assets/images/blog/ossem_creating_xpath_queries/2021-06-22_00_blog_image.png" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2021-06-22T08:00:00-04:00" />
    <meta property="article:modified_time" content="2021-06-22T08:00:00-04:00" />
    <meta property="article:tag" content="Ossem" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="OSSEM Detection Model: Leveraging Data Relationships to Generate Windows Event XPath Queries" />
    <meta name="twitter:description" content="In this blogpost, we will introduce the OSSEM Detection Model project and show you how to use it to create Windows Event XPath queries. These XPath queries can then be used to improve your data collection strategy. Prerequisites We highly recommend reading the following blog post about OSSEM Data Dictionaries" />
    <meta name="twitter:url" content="https://blog.openthreatresearch.com/" />
    <meta name="twitter:image" content="https://blog.openthreatresearch.com/assets/images/blog/ossem_creating_xpath_queries/2021-06-22_00_blog_image.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Open Threat Research Blog" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Ossem" />
    <meta name="twitter:site" content="@OTR_Community" />
    <meta name="twitter:creator" content="@OTR_Community" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Open Threat Research Blog",
        "logo": "https://blog.openthreatresearch.com/false"
    },
    "url": "https://blog.openthreatresearch.com/ossem_generation_xpath_queries",
    "image": {
        "@type": "ImageObject",
        "url": "https://blog.openthreatresearch.com/assets/images/blog/ossem_creating_xpath_queries/2021-06-22_00_blog_image.png",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://blog.openthreatresearch.com/ossem_generation_xpath_queries"
    },
    "description": "In this blogpost, we will introduce the OSSEM Detection Model project and show you how to use it to create Windows Event XPath queries. These XPath queries can then be used to improve your data collection strategy. Prerequisites We highly recommend reading the following blog post about OSSEM Data Dictionaries"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="OSSEM Detection Model: Leveraging Data Relationships to Generate Windows Event XPath Queries" href="/feed.xml" />


</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://blog.openthreatresearch.com/">Open Threat Research Blog</a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">About</a></li>
    <li class="nav-getting-started" role="menuitem"><a href="/tag/getting-started/">Getting Started</a></li>
    <!--<li class="nav-try-ghost" role="menuitem"><a href="https://ghost.org">Try Ghost</a></li>-->
</ul>

        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
            
                <a class="social-link social-link-tw" href="https://twitter.com/OTR_Community" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            
        </div>
        
            <a class="subscribe-button" href="#subscribe">Subscribe</a>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  tag-ossem post ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="22 June 2021">22 June 2021</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/tag/ossem/'>OSSEM</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">OSSEM Detection Model: Leveraging Data Relationships to Generate Windows Event XPath Queries</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/assets/images/blog/ossem_creating_xpath_queries/2021-06-22_00_blog_image.png)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>In this blogpost, we will introduce the <a href="https://github.com/OTRF/OSSEM-DM">OSSEM Detection Model</a> project and show you how to use it to create Windows Event <strong>XPath queries</strong>. These XPath queries can then be used to improve your data collection strategy.</p>

<h1 id="prerequisites">Prerequisites</h1>

<p>We highly recommend reading the following blog post about OSSEM Data Dictionaries (DD): <a href="https://blog.openthreatresearch.com/ossem_security_telemetry_correlation">OSSEM Data Dictionaries: Correlating Security Telemetry</a>. That should provide some context about the project.</p>

<h1 id="ossem-detection-model">OSSEM Detection Model</h1>

<h3 id="what-is-ossem">What is OSSEM?</h3>

<p>The Open Source Security Events Metadata (OSSEM) is a community-led project that focuses primarily on the documentation and standardization of security event logs from diverse data sources and operating systems. Security events are documented in a <code class="language-plaintext highlighter-rouge">data dictionary (DD)</code> format, and they can be used as a reference while mapping data sources to data analytics used to validate the detection of adversarial techniques. In addition, the project provides a <code class="language-plaintext highlighter-rouge">common data model (CDM)</code> that can be used for data engineers during data normalization procedures to allow security analysts to query and analyze data across diverse data sources. Finally, the project also provides documentation about the structure and relationships identified in specific data sources to facilitate the development of data analytics and adversary behavior representation from a data perspective. These relationships are stored under the <code class="language-plaintext highlighter-rouge">detection model (DM)</code> section of the project.</p>

<p><img src="assets/images/blog/ossem_correlating_events/2021-06-21_01_ossem_components.png" alt="" /></p>

<h3 id="what-are-data-relationships">What are Data Relationships?</h3>

<p>Data relationships are structures that can help us describe and represent actions and behaviors (group of related actions) that can be performed within a network environment. The <a href="https://github.com/OTRF/OSSEM-DM/tree/main/relationships">OSSEM relationships</a> are stored in an easy to consume <code class="language-plaintext highlighter-rouge">yaml</code> format. Here is an example of a relationship that describes the action of a <a href="https://github.com/OTRF/OSSEM-DM/blob/main/relationships/user_requested_access_to_file.yml">user requesting access to a file</a>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s">User requested access to File</span>
<span class="na">contributors</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">Jose Rodriguez @Cyb3rPandaH</span>
<span class="pi">-</span> <span class="s">Roberto Rodriguez @Cyb3rWard0g</span>
<span class="na">attack</span><span class="pi">:</span>
  <span class="na">data_source</span><span class="pi">:</span> <span class="s">File</span>
  <span class="na">data_component</span><span class="pi">:</span> <span class="s">file access</span>
<span class="na">behavior</span><span class="pi">:</span>
  <span class="na">source</span><span class="pi">:</span> <span class="s">user</span>
  <span class="na">relationship</span><span class="pi">:</span> <span class="s">requested access to</span>
  <span class="na">target</span><span class="pi">:</span> <span class="s">file</span>
<span class="na">security_events</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">event_id</span><span class="pi">:</span> <span class="m">4656</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">A handle to an object was requested.</span>
  <span class="na">platform</span><span class="pi">:</span> <span class="s">Windows</span>
  <span class="na">audit_category</span><span class="pi">:</span> <span class="s">Object Access</span>
  <span class="na">audit_sub_category</span><span class="pi">:</span> <span class="s">File System</span>
  <span class="na">log_channel</span><span class="pi">:</span> <span class="s">Security</span>
  <span class="na">log_provider</span><span class="pi">:</span> <span class="s">Microsoft-Windows-Security-Auditing</span>
  <span class="na">filter_in</span><span class="pi">:</span>
    <span class="na">ObjectType</span><span class="pi">:</span> <span class="s">File</span>
<span class="na">references</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4656</span>
<span class="na">notes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">Event</span><span class="nv"> </span><span class="s">4656:</span><span class="nv"> </span><span class="s">This</span><span class="nv"> </span><span class="s">event</span><span class="nv"> </span><span class="s">generates</span><span class="nv"> </span><span class="s">only</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">object’s</span><span class="nv"> </span><span class="s">SACL</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">required</span><span class="nv"> </span><span class="s">ACE</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">handle</span><span class="nv"> </span><span class="s">specific</span><span class="nv"> </span><span class="s">access</span><span class="nv"> </span><span class="s">right</span><span class="nv"> </span><span class="s">use.'</span>
</code></pre></div></div>

<h3 id="what-metadata-is-provided-by-the-ossem-dm-project">What metadata is provided by the OSSEM DM project?</h3>

<ul>
  <li>
    <p><strong>ATT&amp;CK mapping</strong>: The data sources piece of the <a href="https://attack.mitre.org/">MITRE-ATT&amp;CK framework</a> has been updated recently, and it now includes more metadata such as <code class="language-plaintext highlighter-rouge">platform</code>, <code class="language-plaintext highlighter-rouge">collection layer</code>, <code class="language-plaintext highlighter-rouge">data components</code> and <code class="language-plaintext highlighter-rouge">data relationships</code>. You can find more information about it <a href="https://github.com/mitre-attack/attack-datasources">here</a>. If an OSSEM relationship is part of ATT&amp;CK data sources metadata, we provide the name of the data source and the data component.</p>
  </li>
  <li>
    <p><strong>Behavior</strong>: The activity described by a relationship is represented by three elements, <code class="language-plaintext highlighter-rouge">source</code>, <code class="language-plaintext highlighter-rouge">relationship</code> and <code class="language-plaintext highlighter-rouge">target</code>. Source is usually the element that performs the main action in the relationship. For example, <code class="language-plaintext highlighter-rouge">user</code> -&gt; <code class="language-plaintext highlighter-rouge">created</code> -&gt; <code class="language-plaintext highlighter-rouge">file</code>. In this example, <code class="language-plaintext highlighter-rouge">user</code> is the <code class="language-plaintext highlighter-rouge">source</code>, <code class="language-plaintext highlighter-rouge">created</code> is the <code class="language-plaintext highlighter-rouge">relationship</code> and <code class="language-plaintext highlighter-rouge">file</code> the target. There are cases where the <code class="language-plaintext highlighter-rouge">source</code> does not have a <code class="language-plaintext highlighter-rouge">target</code> and there is because the <code class="language-plaintext highlighter-rouge">relationship</code> is simply describing the state of the <code class="language-plaintext highlighter-rouge">source</code>. For example, <code class="language-plaintext highlighter-rouge">file modified</code>.</p>
  </li>
  <li>
    <p><strong>Security Events</strong>: Every relationship within the OSSEM-DM project is based on security events. Therefore, in this section of the yaml file, we share event logs that can be collected in you network environment. Also, we add a <code class="language-plaintext highlighter-rouge">filter_in</code> section for each event to provide additional context for those events that might have multiple definitions depending on how they are created. For example, if we use Security event <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4656">4656 (A handle to an object was requested)</a>, we can tell that the values of the <code class="language-plaintext highlighter-rouge">ObjectType</code> field can reference different objects such as <code class="language-plaintext highlighter-rouge">file</code>, <code class="language-plaintext highlighter-rouge">windows registry key</code>, and even <code class="language-plaintext highlighter-rouge">process</code>.</p>
  </li>
</ul>

<h3 id="how-can-we-define-data-relationships">How can we define data relationships?</h3>

<p>There are three basic steps that you can follow to define a relationship:</p>
<ul>
  <li>Identify sources of data</li>
  <li>Identify data entities</li>
  <li>Identify relationships among data entities</li>
</ul>

<p><strong>a) Identify sources of data</strong></p>

<p>We would start by choosing event logs that have been collected in our network environment. After that, we would try to understand the context behind these events, and check if we have already documented them somewhere. Here is where data dictionaries are very useful because they can expedite the research process. As mentioned before, the OSSEM project has a <a href="https://github.com/OTRF/OSSEM-DD">data dictionaries</a> component that you can use as a reference. For the purpose of this section, let’s use event 4656 as an example. The image below, is the <a href="https://github.com/OTRF/OSSEM-DD/blob/main/windows/etw-providers/Microsoft-Windows-Security-Auditing/events/event-4656_v1.yml">YAML representation of the event</a>) in the OSSEM DD project:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">title</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Event</span><span class="nv"> </span><span class="s">ID</span><span class="nv"> </span><span class="s">4656:</span><span class="nv"> </span><span class="s">A</span><span class="nv"> </span><span class="s">handle</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">an</span><span class="nv"> </span><span class="s">object</span><span class="nv"> </span><span class="s">was</span><span class="nv"> </span><span class="s">requested'</span>
<span class="na">description</span><span class="pi">:</span> <span class="s">This event indicates that specific access was requested for an object.</span>
  <span class="s">The object could be a file system, kernel, or registry object, or a file system</span>
  <span class="s">object on removable storage or a device.</span>
<span class="na">platform</span><span class="pi">:</span> <span class="s">windows</span>
<span class="na">log_source</span><span class="pi">:</span> <span class="s">Microsoft-Windows-Security-Auditing</span>
<span class="na">event_code</span><span class="pi">:</span> <span class="s1">'</span><span class="s">4656'</span>
<span class="na">event_version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">1'</span>
<span class="na">event_fields</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">standard_name</span><span class="pi">:</span> <span class="s">user_logon_id</span>
  <span class="na">standard_type</span><span class="pi">:</span> <span class="s">TBD</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">SubjectLogonId</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">HexInt64</span>
  <span class="na">description</span><span class="pi">:</span> <span class="s">hexadecimal value that can help you correlate this event with recent</span>
    <span class="s">events that might contain the same Logon ID</span>
  <span class="na">sample_value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0x4367b'</span>
<span class="pi">-</span> <span class="na">standard_name</span><span class="pi">:</span> <span class="s">object_type</span>
  <span class="na">standard_type</span><span class="pi">:</span> <span class="s">TBD</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ObjectType</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">UnicodeString</span>
  <span class="na">description</span><span class="pi">:</span> <span class="s">The type of an object that was accessed during the operation.</span>
  <span class="na">sample_value</span><span class="pi">:</span> <span class="s">File</span>
<span class="pi">-</span> <span class="na">standard_name</span><span class="pi">:</span> <span class="s">object_name</span>
  <span class="na">standard_type</span><span class="pi">:</span> <span class="s">TBD</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ObjectName</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">UnicodeString</span>
  <span class="na">description</span><span class="pi">:</span> <span class="s">name and other identifying information for the object for which access</span>
    <span class="s">was requested. For example, for a file, the path would be included.</span>
  <span class="na">sample_value</span><span class="pi">:</span> <span class="s">C:\Documents\HBI Data.txt</span>
<span class="na">references</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">text</span><span class="pi">:</span> <span class="s">MS Source</span>
  <span class="na">link</span><span class="pi">:</span> <span class="s">https://github.com/MicrosoftDocs/windows-itpro-docs/blob/master/windows/security/threat-protection/auditing/event-4656.md</span>
<span class="na">tags</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">Object Access</span>
<span class="pi">-</span> <span class="s">Audit File System</span>
<span class="pi">-</span> <span class="s">Audit Kernel Object</span>
<span class="pi">-</span> <span class="s">Audit Registry</span>
<span class="pi">-</span> <span class="s">Audit Removable Storage</span>
</code></pre></div></div>

<p><strong>b) Identify data entities</strong></p>

<p>After understanding the context provided by an event log, we can categorize the metadata that it provides. For example, in event 4656, there is information about a <code class="language-plaintext highlighter-rouge">user</code> requesting access to an <code class="language-plaintext highlighter-rouge">object</code>. These two elements identified in the event are what we call entities and as we also mentioned before, an object can represent multiple things. Therefore, we can easily document more than 2 entities in this event.</p>

<p><strong>c) Identify relationships among data entities</strong></p>

<p>Based on the previous section, we can now identify the activity that connects our entities. The main entity performing the action would be the <code class="language-plaintext highlighter-rouge">source</code> while the other one is the <code class="language-plaintext highlighter-rouge">target</code>. In event 4656, the <code class="language-plaintext highlighter-rouge">user</code> is the <code class="language-plaintext highlighter-rouge">source</code> meanwhile <code class="language-plaintext highlighter-rouge">file</code>, <code class="language-plaintext highlighter-rouge">Windows registry</code>, and <code class="language-plaintext highlighter-rouge">process</code> would be considered <code class="language-plaintext highlighter-rouge">targets</code>. Finally, the action of <code class="language-plaintext highlighter-rouge">requesting access</code> would be the <code class="language-plaintext highlighter-rouge">relationship</code>.</p>

<p><img src="assets/images/blog/ossem_creating_xpath_queries/2021-06-22_01_relationships_among_entities.png" alt="" /></p>

<h1 id="what-can-we-do-with-all-this-information">What Can We Do with All this Information?</h1>

<p>There are several things you can do with the research shared through OSSEM DM. The example we are covering in this post is related to the creation of Windows Event XPath queries to create custom filters and explore Windows security events. You might be asking yourself how this is possible from YAML files. We carefully worked on the schema of each relationship in the project to allow the output of the research to be in different formats. For example, XML.</p>

<h2 id="cant-you-filter-events-via-event-viewer">Can’t You Filter Events via Event Viewer?</h2>

<p>Yes, but there are some limitations when trying to do it all only via the main UI filters. There are some additional options that could help you to customize your searching. Let’s walk through an example of how to filter events via Event Viewer:</p>

<p><strong>a) Exploring Events via Event Viewer</strong></p>

<p>If you open Event Viewer and go to <code class="language-plaintext highlighter-rouge">Windows Logs</code> &gt; <code class="language-plaintext highlighter-rouge">Security</code>, you can see different event logs such as <code class="language-plaintext highlighter-rouge">4688</code>, <code class="language-plaintext highlighter-rouge">4656</code>, and <code class="language-plaintext highlighter-rouge">5156</code>.</p>

<p><img src="assets/images/blog/ossem_creating_xpath_queries/2021-06-22_02_event_viewer_application.png" alt="" /></p>

<p><strong>b) Filtering relevant telemetry</strong></p>

<p>If you did not know, when you select the option to filter the current log, there are two ways to do this. One is named <code class="language-plaintext highlighter-rouge">Filter</code> and the other one <code class="language-plaintext highlighter-rouge">XML</code>. When you use the <code class="language-plaintext highlighter-rouge">Filter</code> option, the application will automatically create an <code class="language-plaintext highlighter-rouge">XPath query</code> that you can see if you switch the filter option to <code class="language-plaintext highlighter-rouge">XML</code>. Let’s use this basic filter to only show events of <code class="language-plaintext highlighter-rouge">EventID</code> 4656. The difference between <code class="language-plaintext highlighter-rouge">Filter</code> and <code class="language-plaintext highlighter-rouge">XML</code> is that with <code class="language-plaintext highlighter-rouge">XML</code> we have more freedom to search for patterns in the event that go beyond the <code class="language-plaintext highlighter-rouge">EventID</code>, <code class="language-plaintext highlighter-rouge">Event Level</code>, <code class="language-plaintext highlighter-rouge">Task Category</code> and even <code class="language-plaintext highlighter-rouge">Event Sources</code>. With <code class="language-plaintext highlighter-rouge">XML</code>, you can access the <code class="language-plaintext highlighter-rouge">EventData</code> node of the XML representation of the security event.</p>

<p><img src="assets/images/blog/ossem_creating_xpath_queries/2021-06-22_03_event_viewer_filters.png" alt="" /></p>

<p><img src="assets/images/blog/ossem_creating_xpath_queries/2021-06-22_04_event_4656_filtered.png" alt="" /></p>

<h2 id="create-xpath-queries-mapped-to-mitre-attck">Create XPath Queries Mapped to MITRE ATT&amp;CK</h2>

<p>As mentioned before, if we want to filter Windows Security events using a more complex logic, we would use XPath queries. Let’s use all the relationships that we have already mapped to the <a href="https://github.com/OTRF/OSSEM-DM/tree/main/use-cases/mitre_attack">MITRE-ATT&amp;CK</a> project, translate them to XML documents, validate the search patterns and export XPath queries all via PowerShell.</p>

<p>In OSSEM DM, we programmatically create multiple files as part of the use cases we cover by processing every single relationship in YAML format. As mentioned before, we map everything to ATT&amp;CK and we save the output as <a href="https://raw.githubusercontent.com/OTRF/OSSEM-DM/main/use-cases/mitre_attack/techniques_to_events_mapping.json">JSON</a> and <a href="https://raw.githubusercontent.com/OTRF/OSSEM-DM/main/use-cases/mitre_attack/techniques_to_events_mapping.yaml">YAML</a> files. For this post, we are going to use the JSON one.</p>

<p><strong>a) Download relationships mapped to ATT&amp;CK</strong></p>

<ul>
  <li>Open PowerShell with Administrator rights.</li>
</ul>

<p><img src="assets/images/blog/ossem_creating_xpath_queries/2021-06-22_05_running_powershell.png" alt="" /></p>

<ul>
  <li>Set the current directory (PowerShell session only) by running the following code.</li>
</ul>

<pre><code class="language-PowerShell">[Environment]::CurrentDirectory=(Get-Location -PSProvider FileSystem).ProviderPath
</code></pre>

<ul>
  <li>Set the url to the raw json file within the OSSEM DM GitHub repository.</li>
</ul>

<pre><code class="language-PowerShell">$uri = "https://raw.githubusercontent.com/OTRF/OSSEM-DM/main/use-cases/mitre_attack/techniques_to_events_mapping.json"
</code></pre>

<ul>
  <li>Initialize a Web Client.</li>
</ul>

<pre><code class="language-PowerShell">[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
$wc = new-object System.Net.WebClient
</code></pre>

<ul>
  <li>Download the JSON file.</li>
</ul>

<pre><code class="language-PowerShell">$wc.DownloadFile($uri, "techniques_to_events_mapping.json")
</code></pre>

<ul>
  <li>Read the JSON file as an Array and validate it was downloaded correctly by selecting the first object.</li>
</ul>

<pre><code class="language-PowerShell">$mappings = Get-Content .\techniques_to_events_mapping.json | ConvertFrom-Json
$mappings[0] 
</code></pre>

<p><img src="assets/images/blog/ossem_creating_xpath_queries/2021-06-22_06_downloading_json_file.png" alt="" /></p>

<p><strong>b) Create XML query files</strong></p>

<ul>
  <li>Extract the metadata within the JSON file to a dictionary</li>
</ul>

<pre><code class="language-PowerShell">$allMappings = @{}
foreach ($item in $mappings) {
    if ($item.log_channel -eq 'Security'){
        if (!($allMappings.contains($item.data_source))){
            $allMappings.$($item.data_source) = @{}
        }
        if (!($allMappings[$item.data_source].contains($item.data_component))){
            $allMappings[$item.data_source][$item.data_component] = @()
        }
        if (!($allMappings[$item.data_source][$item.data_component] | Where-Object {$_.EventID -eq "$($item.event_id)"})) {
            $eventObject = @{
                EventID = "$($item.event_id)"
                EventName = "$($item.event_name)"
            }
            if ($item.filter_in.ToString() -ne 'NaN'){
                $eventObject += @{Filters = $item.filter_in}
            }
            $allMappings[$item.data_source][$item.data_component] += $eventObject
        }
    }
}
</code></pre>

<p><img src="assets/images/blog/ossem_creating_xpath_queries/2021-06-22_07_metadata_dictionary.png" alt="" /></p>

<ul>
  <li>Create XML files for each ATT&amp;CK data source. Indeed, the name of each XML file will be the ATTCK data source mapped on each relationship.</li>
</ul>

<pre><code class="language-PowerShell">foreach ($ds in $allMappings.Keys){
    $fileName = -join (($ds -replace " ","-").ToLower(), '.xml')
    $StringWriter = New-Object System.IO.StringWriter
    $XmlWriter = New-Object System.XMl.XmlTextWriter $StringWriter
    $xmlWriter.Formatting = "indented"
    $xmlWriter.Indentation = 2
    $xmlWriter.IndentChar = ' '
    $xmlWriter.WriteStartDocument()
    $xmlWriter.WriteStartElement("QueryList")
    $xmlWriter.WriteComment("ATT&amp;CK Data Source - $ds")

    $Counter = 0
    foreach ($dc in $allMappings[$ds].Keys) {
        # Create query element
        $xmlWriter.WriteStartElement("Query")
            $xmlWriter.WriteAttributeString("Id", "$Counter")
            $xmlWriter.WriteAttributeString("Path", "Security")
            $xmlWriter.WriteComment("ATT&amp;CK Data Component - $dc")
            # Create query strings
            $query = ""
            $leftover = @()
            foreach ($event in $allMappings[$ds][$dc]){
                $xmlWriter.WriteComment("$($Event.EventID) - $($Event.EventName)")
                if ($Event.Filters){
                    $leftover += $Event
                }
                else {
                    $query = -join ($query, " EventID=$($Event.EventID) ")
                    if (!($allMappings[$ds][$dc][-1]['EventID'] -eq $($Event.EventID))){
                        $query = -join ($query, "or")
                    }
                }
            }
            if ($allMappings[$ds][$dc].Count -ne $leftover.Count){
                $query = $query.Trim()
                $query = -join ("*[System[(", $query, ")]]")
                if ($leftover.Count -ne 0){
                    $query = -join ($query, ' or ')
                }
            }
            # Process leftover
            if ($leftover){
                foreach ($l in $leftover){
                    $query = -join ($query, "(*[System[EventID=$($l.EventID)]] and (")
                    foreach ($f in $l.Filters) {
                        $key = $f | get-member -MemberType NoteProperty | select -expandproperty Name
                        $query = -join ($query, "(*[EventData[Data[@Name='$($key)']='$($f.$key)'")
                        if (!($l.Filters[-1] -eq $($f))){
                            $query = -join ($query, "]] or ")
                        }
                        else {
                            $query = -join ($query, "]])))")
                        }
                    }
                    if (!($leftover[-1] -eq $($l))){
                        $query = -join ($query, " or ")
                    }
                }
            }
            # Create Select (query) Element
            $xmlWriter.WriteStartElement("Select")
                $xmlWriter.WriteAttributeString("Path", "Security")
                $xmlWriter.WriteString("$query")
            $xmlWriter.WriteEndElement() | out-null
        $xmlWriter.WriteEndElement() | out-null
        $counter += 1
    }
    # Write Close Tag for QueryList Element
    $xmlWriter.WriteEndDocument() | out-null
    # Finish The Document
    $xmlWriter.Flush() | out-null
    $StringWriter.Flush() | out-null
    #Create File
    $StringWriter.ToString() | out-file $fileName
    $xmlWriter.Close()
}
</code></pre>

<p><img src="assets/images/blog/ossem_creating_xpath_queries/2021-06-22_08_creating_xml_files.png" alt="" /></p>

<ul>
  <li>Validate the creation of <code class="language-plaintext highlighter-rouge">XML</code> files.</li>
</ul>

<pre><code class="language-PowerShell"># Printing all the files in my current directory
ls
</code></pre>

<p><img src="assets/images/blog/ossem_creating_xpath_queries/2021-06-22_09_validating_creation_xml_files.png" alt="" /></p>

<ul>
  <li>Read the content of the XML file to validate its syntax (initial validation). Let’s use the <code class="language-plaintext highlighter-rouge">windows registry</code> data source as an example (Remember that, in case the name of the data source contained a blank space within its name, the code replaces the blank space with a <code class="language-plaintext highlighter-rouge">-</code> character. For example: user account –&gt; user-account).</li>
</ul>

<pre><code class="language-PowerShell">get-content .\windows-registry.xml
</code></pre>

<p><img src="assets/images/blog/ossem_creating_xpath_queries/2021-06-22_10_validating_xml_file_structure.png" alt="" /></p>

<h2 id="test-xpath-queries">Test XPath Queries</h2>

<p>As a final validation step, let’s run our XPath queries using EventViewer and PowerShell to validate its syntax.</p>

<p><strong>a) Testing through EventViewer</strong></p>

<ul>
  <li>Copy the output of the command that we ran previously named<code class="language-plaintext highlighter-rouge">get-content</code> in the <code class="language-plaintext highlighter-rouge">XML</code> Event Viewer filter option and click <code class="language-plaintext highlighter-rouge">OK</code>.</li>
</ul>

<p><img src="assets/images/blog/ossem_creating_xpath_queries/2021-06-22_11_validating_xml_query_event_viewer.png" alt="" /></p>

<p><img src="assets/images/blog/ossem_creating_xpath_queries/2021-06-22_12_xml_query_event_viewer_result.png" alt="" /></p>

<p><strong>b) Testing through PowerShell</strong></p>

<ul>
  <li>Execute the XPath querry using the <code class="language-plaintext highlighter-rouge">Get-WinEvent</code> command.</li>
</ul>

<pre><code class="language-PowerShell">[xml]$registry_test = get-content .\windows-registry.xml
Get-WinEvent -FilterXml $registry_test
</code></pre>

<p><img src="assets/images/blog/ossem_creating_xpath_queries/2021-06-22_13_validating_xml_query_execution.png" alt="" /></p>

<p><strong>C) Exporting XPath Queries</strong></p>

<pre><code class="language-PowerShell">[xml]$Account = get-content ..\windows-registry.xml
$Account.QueryList.Query | ForEach-Object {-join ($_.Select.Path, '!', $_.Select.'#text') }
</code></pre>

<h1 id="what-else-can-we-do-with-this-xpath-queries">What else can we do with this XPath Queries?</h1>

<p>Within the Open Threat Research (OTR) projects portfolio, you can find a project named <a href="https://github.com/OTRF/Azure-Sentinel2Go">Azure Sentinel To-Go</a>. It allows you to expedite the deployment of an Azure Sentinel lab along with other Azure resources and a data ingestion pipeline to consume pre-recorded datasets for research purposes. One of the recent updates to its Windows data connectors allows the use of <code class="language-plaintext highlighter-rouge">XPath</code> queries to customize the collection of Windows Security events. We could use the previous section and the its output to help <code class="language-plaintext highlighter-rouge">Azure Sentinel</code> users by giving them an idea of how they can improve their data collection strategy based on the research behind the OSSEM DM project.</p>

<p><img src="assets/images/blog/ossem_creating_xpath_queries/2021-06-22_14_windows_security_events_connector.png" alt="" /></p>

<h2 id="creating-xpath-queries-for-azure-sentinel">Creating Xpath Queries for Azure Sentinel**</h2>

<p>Even though we were able to export XPath queries from the OSSEM DM project, we need to change the format a little bit to make it compatible with the APIs used to configure the new version of the Windows Security event data connector in Azure Sentinel.</p>

<p>You can use the following PowerShell code to aggregate all the <code class="language-plaintext highlighter-rouge">.xml</code> files that we created before from the <a href="https://raw.githubusercontent.com/OTRF/OSSEM-DM/main/use-cases/mitre_attack/techniques_to_events_mapping.json">JSON</a> file in the OSSEM DM GitHub repository.</p>

<pre><code class="language-PowerShell">$allFiles = Get-ChildItem -Path *.xml

$AllDataSources = @()
$DataSource = [ordered]@{}
# Name of Data Source
$DataSource['Name'] = "eventLogsDataSource"
# Transfer Period
$DataSource['scheduledTransferPeriod'] = "PT1M"
# Streams
$DataSource['streams'] = @(
    "Microsoft-SecurityEvent"
)
# Process XPath Queries
$DataSource['xPathQueries'] = @()
foreach ($file in $allFiles){
    [xml]$XmlQuery = Get-Content -path $file
    $queries = $xmlQuery.QueryList.Query
    ForEach ($query in $queries){
        $QueryString = "$(-join ($query.Select.Path, '!', $query.Select.'#text'))"
        if ("$QueryString" -notin $DataSource['xPathQueries']){
            $DataSource['xPathQueries'] += $QueryString
        } 
    }
}
$AllDataSources += $DataSource

@{
    windowsEventLogs = $AllDataSources
} | Convertto-Json -Depth 4 | Set-Content "ossem-attack.json" -Encoding UTF8
</code></pre>

<p><img src="assets/images/blog/ossem_creating_xpath_queries/2021-06-22_15_getting_json_file_azure_sentinel.png" alt="" /></p>

<p>You can validate the generation of the JSON file by using the <code class="language-plaintext highlighter-rouge">get-content</code> function.</p>

<pre><code class="language-PowerShell">get-content .\ossem-attack.json
</code></pre>

<p><img src="assets/images/blog/ossem_creating_xpath_queries/2021-06-22_16_json_file_review.png" alt="" /></p>

<h1 id="how-can-we-use-this-file-in-azure-sentinel">How Can We Use This File in Azure Sentinel?</h1>

<p>For that, I recommed readhing the folling blog post written by Roberto Rodriguez (<a href="https://twitter.com/Cyb3rWard0g">@Cyb3rWard0g</a>) from the MSTIC R&amp;D team.</p>

<p>Thank you! That’s it for today. We are working on more use cases to operationalize our researcher shared through the OSSEM project.</p>

<h1 id="references">References</h1>
<ul>
  <li><a href="https://github.com/OTRF/OSSEM-DM/blob/main/scripts/ossemDM_XPath_Queries.ps1">PowerShell script to generate XML files with XPath queries based on OSSEM relationships mapped to ATT&amp;CK and the creation of the file used with the new Azure Sentinel data connector</a></li>
  <li><a href="https://github.com/OTRF/OSSEM-DD">OSSEM Detection Modeling GitHub repository</a></li>
  <li><a href="https://ossemproject.com/intro.html">OSSEM Project Website</a></li>
</ul>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            
                <section class="subscribe-form">
                    <h3 class="subscribe-form-title">Subscribe to Open Threat Research Blog</h3>
                    <p>Get the latest posts delivered right to your inbox</p>
                    <form method="post" action="/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"  /><input class="location" type="hidden" name="location"  /><input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="subscribe-email" type="email" name="email"  placeholder="youremail@example.com" />
    </div>
    <button class="" type="submit" disabled><span>Subscribe</span></button>
    <script type="text/javascript">(function(g,h,o,s,t){h[o]('.location')[s]=h[o]('.location')[s] || g.location.href;h[o]('.referrer')[s]=h[o]('.referrer')[s] || h.referrer;})(window,document,'querySelector','value');</script>
</form>

                </section>
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/images/authors/avatar-jose.jpg" alt="jose" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/jose">Jose Rodriguez</a></h4>
                                
                                    <p>Security Researcher</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/jose">Read More</a>
                        </div>
                    
                
                    
                
                    
                
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            
                                style="background-image: url(url(/assets/images/blog/ossem_creating_xpath_queries/2021-06-22_00_blog_image.png)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; Open Threat Research Blog &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/ossem/">Ossem</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/ossem_security_telemetry_correlation">OSSEM Data Dictionaries: Correlating Security Telemetry</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/ossem/">
                                
                                    See all 1 posts  →
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/ossem_security_telemetry_correlation">
                <div class="post-card-image" style="background-image: url(/assets/images/blog/ossem_correlating_events/2021-06-21_00_blog.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/ossem_security_telemetry_correlation">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Ossem</span>
                            
                        
                    

                    <h2 class="post-card-title">OSSEM Data Dictionaries: Correlating Security Telemetry</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/authors/avatar-jose.jpg" alt="Jose Rodriguez" />
                        
                        <span class="post-card-author">
                            <a href="/author/jose/">Jose Rodriguez</a>
                        </span>
                    
                
                    
                
                    
                
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://blog.openthreatresearch.com/">
            
                <img src="/assets/images/favicon.png" alt="Open Threat Research Blog icon" />
            
            <span>Open Threat Research Blog</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">OSSEM Detection Model: Leveraging Data Relationships to Generate Windows Event XPath Queries</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=OSSEM+Detection+Model%3A+Leveraging+Data+Relationships+to+Generate+Windows+Event+XPath+Queries&amp;url=ossem_generation_xpath_queries"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=ossem_generation_xpath_queries"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://blog.openthreatresearch.com/">Open Threat Research Blog</a> &copy; 2021</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyller/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    
                    <a href="https://twitter.com/OTR_Community" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    
        <div id="subscribe" class="subscribe-overlay">
            <a class="subscribe-overlay-close" href="#"></a>
            <div class="subscribe-overlay-content">
                
                <h1 class="subscribe-overlay-title">Subscribe to Open Threat Research Blog</h1>
                <p class="subscribe-overlay-description">Stay up to date! Get all the latest &amp; greatest posts delivered straight to your inbox</p>
                <form method="post" action="/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"  /><input class="location" type="hidden" name="location"  /><input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="subscribe-email" type="email" name="email"  placeholder="youremail@example.com" />
    </div>
    <button class="" type="submit" disabled><span>Subscribe</span></button>
    <script type="text/javascript">(function(g,h,o,s,t){h[o]('.location')[s]=h[o]('.location')[s] || g.location.href;h[o]('.referrer')[s]=h[o]('.referrer')[s] || h.referrer;})(window,document,'querySelector','value');</script>
</form>

            </div>
        </div>
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
